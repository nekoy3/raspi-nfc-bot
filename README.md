# raspi-nfc-bot
このBotはDiscord上で部屋の入退室を管理する、https://github.com/nekoy3/RoomManageBot の部屋人数管理Botの改良版です。  
使用ライブラリをpy-cord2.0.0b7からDiscord.py2.0.0に変更したため、メッセージの読み取り関連も実装することで、いくつか仕様が変更、改善されました。

# 大きな変更点  
- gcコマンドを廃止  
  - 代わりに、グローバルチャット用チャンネルを双方ギルド（サーバー）で用意しておくことで、botが自動的にwebhookを生成してやり取りが出来るようになりました。  
  - コマンドを使わない分、ファイル送信や改行コード付きメッセージの送信にも対応し、ユーザーのアイコンも正しく表記されるようになりました。  
  
- カード認証システムに伴うin/outコマンドの廃止  
  - discordユーザと学生証などのカードをあらかじめ登録し紐付けておくことで、nfcリーダにカードをタッチするのみで入退室認証が出来るようになりました。
  - これによりコマンド入力の手間や毎回スマホ等で操作をする必要がなくなりました。  
  - ~~タッチを忘れていた場合は、あとから認証時刻を修正することも出来ます。~~v1.0現在未実装  
  - ~~帰り際にタッチを忘れていた場合は、コマンドで退室認証をすることも出来ます。~~v1.0現在未実装  

# Usage
必要なライブラリ（discord.py2.0.0とnfcpy)をインストールし、main.pyを動作に必要なid,botのトークンをconfig.ini設定し実行することで動作します。  
config.iniを記述して、その2つのチャンネル間でのみ動作します。  
また、部屋の入口にRaspberry Pi 2 Model Bと、Pasori RC-S380が接続されてRaspberry Pi上での動作を想定しています。  

### 使い方
部屋の入口にRaspberry PiとNFCリーダー(カードリーダー)を設置して動作しているので、部屋に入退室する際に学生証をカードリーダーにタッチすることで自動的に認証~~して入退室したユーザーと時刻をデータベースに記録~~します。  
また、認証するには最初に学生証をBotを通じて登録する必要があります。「/regist」コマンドを使って登録してください。  
- registコマンド  
  1. 「/regist st-num:学籍番号 st-name:氏名」を入力する。フォーマットは引数入力時に説明文が出るのでそれに従う。  
  ![image](https://user-images.githubusercontent.com/84169441/195560204-f6e0161f-baa4-45d7-b8f4-b52d9e8ef442.png)
  2. botから以下のようなメッセージが届くので、 緑色の「登録する」ボタンを押す。    
  ![image](https://user-images.githubusercontent.com/84169441/195560648-1cd9cc38-2b51-4c99-b23f-db31c16d3fba.png)
  ※このボタンは表示されて1分のみ有効で、どちらかを押すと有効期限が切れるので、失敗した場合は再度コマンドを実行してやり直してください。  
  3. 以下のようなメッセージが表示されるので、未登録の学生証をカードリーダーにかざしてください。
  ![スクリーンショット 2022-08-26 151402](https://user-images.githubusercontent.com/84169441/186834870-e4c26862-4c7b-45d4-a909-49b5f49e11f5.png)  
  4.以下のようなメッセージが表示されたら登録完了です。以降、学生証をタッチするのみで誰がいつ出入りしたかを自動で記録します。  
  ![image](https://user-images.githubusercontent.com/84169441/195559907-25fe569a-8f7a-4748-bb1f-e35a113b6238.png)  
   
~~学生証のタッチを忘れていた場合は、「/fix」コマンドを使って情報を修正する事が出来ます。~~v1.0未実装  
- fixコマンド  
  「/fix type:time time:時刻(時間(24h):分」 前回自身がカードタッチで認証した時間を変更します。遅れたタイミングでタッチした後、入った時刻や退室した時刻に修正してください。  
  「/fix type:out time:時刻(時間(24h):分」　退室した時にカードタッチを忘れてしまった場合は、コマンド上でtimeを指定して退室認証を行えます。退室した推定時刻も入力してください。  
  
### 人数オーバー時の警告
入退室認証で人数を検出し、10人(config.iniで設定可)している場合、密である趣旨の警告を表示します。  
警告を表示する間隔は、最小で150分(config.iniで設定可)です。  
  
### 入室中メンバーの表示
メンバーが一人以上残っている場合は、毎時刻にメンバー全員を名前で表示します。登録忘れ等を防ぐために入退室後はある程度確認してください。  
  
### グローバルチャット機能
あらかじめ決めておいた２つのチャンネル（２つのサーバーidの中のみ）において、  
互いにチャットを共有することが出来ます。  
使い方は登録されたチャンネルで発言するのみ。コマンドは必要ありません。  
![image](https://user-images.githubusercontent.com/84169441/201012187-f51d4056-aaae-456b-8313-821daa4dc7fc.png)  
  
![image](https://user-images.githubusercontent.com/84169441/201012296-f16ef281-8fc2-4728-bda8-76d1c1e06e66.png)  
絵文字や改行も反映されます。  
ファイル等も送信できるようになりました。
  
# Note
データベースファイルに学生証データを蓄積するテーブルを生成し、studentsテーブルに「固有ID(int)」「学籍番号(string)」「名前(string)」「discordユーザid(int)」「登録日(string)」「部屋にいるかのフラグ(boolean)」を蓄積し、cardテーブルにはdiscordユーザidを主キーとし「カードID(string)」を蓄積する。  
  
*    *    *
# version
### 2022/11/10  
- 初期バージョン  
